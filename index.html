<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NyxMesh ‚Ä¢ Distributed Browser Computing Platform (POC)</title>
<style>
  :root{
    --bg:#0a0a0f;--panel:#141420;--ink:#f8f9fa;--muted:#8892b0;--accent:#6366f1;--accent-2:#10b981;
    --accent-hover:#818cf8;--good:#34d399;--warn:#fbbf24;--bad:#f87171;--line:#374151;--chip:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font:14px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:radial-gradient(1200px 600px at 20% 0%,#1e1b4b 0%,var(--bg) 70%);color:var(--ink);
    display:flex;justify-content:center;padding:20px
  }
  .container{width:100%;max-width:1400px;display:grid;grid-template-columns:500px 1fr;gap:24px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;backdrop-filter:blur(12px)}
  .hero-card{background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(16,185,129,0.1));border:1px solid rgba(99,102,241,0.3)}
  h1{margin:0 0 12px;font-size:24px;font-weight:700;background:linear-gradient(135deg, #6366f1, #10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  h2{margin:20px 0 12px;font-size:18px;color:var(--ink);font-weight:600}
  h3{margin:12px 0 8px;font-size:16px;color:var(--muted);font-weight:500}
  .subtitle{color:var(--muted);font-size:16px;margin-bottom:20px;line-height:1.6}
  .value-prop{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:12px;padding:16px;margin:16px 0}
  .value-prop strong{color:var(--accent)}
  .metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
  .metric{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:16px;text-align:center}
  .metric-label{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px}
  .metric-value{font-size:28px;font-weight:800;color:var(--ink)}
  .metric-unit{font-size:14px;color:var(--muted);margin-left:4px}
  .status-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600}
  .status-idle{background:rgba(139,92,246,0.2);color:#a78bfa}
  .status-active{background:rgba(34,197,94,0.2);color:#4ade80}
  .status-connecting{background:rgba(251,191,36,0.2);color:#fbbf24}
  .btn{background:var(--accent);color:white;border:0;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:14px}
  .btn:hover{background:var(--accent-hover);transform:translateY(-1px)}
  .btn-secondary{background:var(--chip);color:var(--ink);border:1px solid var(--line)}
  .btn-success{background:var(--good);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:16px 0}
  input{accent-color:#6366f1}
  input[type=range]{width:100%}
  .slider-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:13px;color:var(--muted);display:block}
  .label-line{display:flex;justify-content:space-between}
  canvas{width:100%;height:auto;background:var(--bg);border:1px solid var(--line);border-radius:12px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
  .worker-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .worker{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px;border:1px solid var(--line);border-radius:10px;background:rgba(31,41,55,0.5)}
  .worker-id{font-family:ui-monospace,monospace;font-size:12px}
  .worker-status{font-size:11px;color:var(--muted)}
  .perf-badge{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(34,197,94,0.2);color:#4ade80}
  .invite-section{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:12px;padding:16px;margin:16px 0}
  .invite-url{font-family:ui-monospace,monospace;background:var(--bg);border:1px solid var(--line);border-radius:8px;padding:12px;word-break:break-all;margin:8px 0}
  .activity-log{height:120px;overflow:auto;background:var(--bg);border:1px solid var(--line);border-radius:8px;padding:12px;font-family:ui-monospace,monospace;font-size:12px;color:var(--muted)}
  /* Session pill */
  .session-pill{display:none;gap:8px;align-items:center;background:rgba(31,41,55,0.5);border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin:8px 0 0 0;width:fit-content}
  .session-pill code{font-family:ui-monospace,monospace;font-size:12px;padding:2px 6px;background:var(--bg);border:1px solid var(--line);border-radius:6px}
  .mini-btn{background:var(--chip);color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:12px;cursor:pointer}
  .mini-btn:hover{background:#232838}
  @media (max-width: 1100px) {
    .container{grid-template-columns:1fr;gap:16px}
    .metrics-grid{grid-template-columns:1fr 1fr 1fr}
  }
</style>
</head>
<body>
<div class="container">
  <!-- Control Panel -->
  <div class="card hero-card">
    <h1>üß¨ NyxMesh</h1>
    <div class="subtitle">Distributed Browser Computing Platform</div>

    <div class="value-prop">
      <strong>Proof of Concept:</strong> Every browser tab becomes a compute node. Open more tabs ‚Üí solve faster. No installs. No cloud.
    </div>

    <!-- Network + Session -->
    <h3>Network Status</h3>
    <div class="status-badge status-idle" id="networkStatus">
      <span>‚ö°</span>
      <span id="statusText">Ready</span>
    </div>
    <div class="session-pill" id="sessionPill">
      <span style="color:var(--muted)">Session</span>
      <code id="sessionCode">‚Äî</code>
      <button class="mini-btn" id="copyIdBtn">Copy ID</button>
      <button class="mini-btn" id="copyLinkBtn">Copy Link</button>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
      <div class="metric">
        <div class="metric-label">Active Nodes</div>
        <div class="metric-value" id="nodeCount">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">Compute Power</div>
        <div class="metric-value"><span id="computePower">0</span><span class="metric-unit"> ops/s</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">Speedup</div>
        <div class="metric-value"><span id="performanceGain">1.0</span><span class="metric-unit">√ó</span></div>
      </div>
      <div class="metric">
        <div class="metric-label">Best Distance</div>
        <div class="metric-value" id="bestDist">‚Äî</div>
      </div>
    </div>

    <!-- Demo Controls -->
    <div class="demo-controls">
      <h3 style="margin-top:0">Demo Controls</h3>
      <div class="controls">
        <button id="startDemo" class="btn">üöÄ Start Demo (Coordinator)</button>
        <button id="joinDemo" class="btn btn-success">üë• Join as Worker</button>
        <button id="runOptimization" class="btn btn-secondary" disabled>‚ñ∂ Run Optimization</button>
      </div>
      <div class="slider-row">
        <div>
          <div class="label-line"><label>Problem Size</label><span id="sizeLabel">40</span></div>
          <input id="problemSize" type="range" min="20" max="120" value="40" />
        </div>
        <div>
          <div class="label-line"><label>Workload</label><span id="workLabel">5/10</span></div>
          <input id="workload" type="range" min="1" max="10" value="5" />
        </div>
      </div>
    </div>

    <!-- Invite / Add Nodes -->
    <div class="invite-section" id="inviteSection" style="display:none">
      <h3 style="margin-top:0">üì± Add Nodes</h3>
      <div class="invite-url" id="inviteUrl">Open this exact file in other tabs/devices and click ‚ÄúJoin as Worker‚Äù.</div>
      <div class="controls">
        <button id="openWorker" class="btn btn-secondary">‚ûï Open Local Worker Tab</button>
      </div>
    </div>

    <!-- Active Nodes -->
    <h3>Compute Nodes <span id="nodeCountBadge" class="status-badge status-idle">0 active</span></h3>
    <div id="workerList" class="worker-list">
      <div style="color:var(--muted);text-align:center;padding:20px">Start demo to see active nodes</div>
    </div>

    <h3>Activity</h3>
    <div id="activityLog" class="activity-log">
      <div style="color:var(--accent)">NyxMesh POC ready</div>
      <div>Open multiple tabs to contribute compute.</div>
    </div>
  </div>

  <!-- Visualization Panel -->
  <div class="card">
    <h2>üéØ Live Optimization</h2>
    <div class="subtitle">Traveling Salesman Problem ‚Äî collaborative solving across tabs</div>
    <canvas id="problemCanvas" width="800" height="500"></canvas>
    <h3>Performance Over Time</h3>
    <canvas id="performanceChart" width="800" height="120"></canvas>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">More nodes ‚áí faster improvement of the purple route</div>
  </div>
</div>

<script>
/* ========= Simple P2P-in-a-tab: BroadcastChannel ========= */
const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('nyxmesh-poc') : null;

/* ========= State ========= */
const peerId = Math.random().toString(36).slice(2,10);
let sessionId = null;
let isCoordinator = false;
let demoRunning = false;
let optimizationRunning = false;

const nodes = new Map(); // id -> {latency, ops, status}
let problemData = [];
let bestSolution = { route: null, distance: Infinity };
let performanceHistory = [];
let metrics = { totalOps: 0, startTime: 0 };

/* ========= DOM ========= */
const el = {
  startDemo: document.getElementById('startDemo'),
  joinDemo: document.getElementById('joinDemo'),
  runOptimization: document.getElementById('runOptimization'),
  openWorker: document.getElementById('openWorker'),
  inviteSection: document.getElementById('inviteSection'),
  inviteUrl: document.getElementById('inviteUrl'),
  networkStatus: document.getElementById('networkStatus'),
  statusText: document.getElementById('statusText'),
  sessionPill: document.getElementById('sessionPill'),
  sessionCode: document.getElementById('sessionCode'),
  copyIdBtn: document.getElementById('copyIdBtn'),
  copyLinkBtn: document.getElementById('copyLinkBtn'),
  nodeCount: document.getElementById('nodeCount'),
  computePower: document.getElementById('computePower'),
  performanceGain: document.getElementById('performanceGain'),
  bestDist: document.getElementById('bestDist'),
  nodeCountBadge: document.getElementById('nodeCountBadge'),
  workerList: document.getElementById('workerList'),
  activityLog: document.getElementById('activityLog'),
  size: document.getElementById('problemSize'),
  sizeLabel: document.getElementById('sizeLabel'),
  work: document.getElementById('workload'),
  workLabel: document.getElementById('workLabel'),
  canvas: document.getElementById('problemCanvas'),
  chart: document.getElementById('performanceChart')
};
const ctx = el.canvas.getContext('2d');
const chartCtx = el.chart.getContext('2d');

/* ========= UI helpers ========= */
function log(msg){
  const t = new Date().toLocaleTimeString();
  const d = document.createElement('div');
  d.innerHTML = `<span style="color:var(--muted)">[${t}]</span> ${msg}`;
  el.activityLog.appendChild(d);
  el.activityLog.scrollTop = el.activityLog.scrollHeight;
}
function setStatus(kind,text){
  el.networkStatus.className = `status-badge status-${kind}`;
  el.statusText.textContent = text;
}
function showSession(){
  el.sessionCode.textContent = sessionId || '‚Äî';
  el.sessionPill.style.display = sessionId ? 'inline-flex' : 'none';
}
function renderWorkers(){
  if (nodes.size===0){
    el.workerList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No active nodes</div>';
    return;
  }
  el.workerList.innerHTML = '';
  for(const [id,n] of nodes){
    const row = document.createElement('div');
    row.className = 'worker';
    row.innerHTML = `
      <div>
        <div class="worker-id">${id}</div>
        <div class="worker-status">${n.status||'active'}</div>
      </div>
      <div class="perf-badge">${(n.latency??'-')} ms</div>
      <div class="perf-badge">${(n.ops??0)} ops</div>
    `;
    el.workerList.appendChild(row);
  }
}
function updateMetrics(){
  const nodeCount = nodes.size;
  const ops = metrics.totalOps / Math.max(1, (Date.now()-metrics.startTime)/1000);
  el.nodeCount.textContent = nodeCount;
  el.computePower.textContent = Math.round(ops);
  el.performanceGain.textContent = (nodeCount>0 ? (1 + (nodeCount-1)*0.8) : 1).toFixed(1);
  el.nodeCountBadge.textContent = `${nodeCount} active`;
  el.nodeCountBadge.className = `status-badge ${nodeCount>0 ? 'status-active':'status-idle'}`;
  el.bestDist.textContent = (bestSolution.distance===Infinity?'‚Äî':Math.round(bestSolution.distance));
}

/* ========= Draw ========= */
function drawProblem(){
  const w = el.canvas.width, h = el.canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = '#f8f9fa';
  for(const c of problemData){ ctx.beginPath(); ctx.arc(c.x,c.y,4,0,Math.PI*2); ctx.fill(); }
  if (bestSolution.route){
    ctx.strokeStyle = '#6366f1'; ctx.lineWidth = 2;
    ctx.beginPath();
    const r = bestSolution.route;
    ctx.moveTo(problemData[r[0]].x, problemData[r[0]].y);
    for(let i=1;i<r.length;i++){ const p = problemData[r[i]]; ctx.lineTo(p.x,p.y); }
    ctx.lineTo(problemData[r[0]].x, problemData[r[0]].y);
    ctx.stroke();
  }
  ctx.fillStyle = '#8892b0'; ctx.font = '14px system-ui, sans-serif';
  ctx.fillText(`${problemData.length} cities`, 20, 30);
  if (bestSolution.distance!==Infinity) ctx.fillText(`Best distance: ${Math.round(bestSolution.distance)}`, 20, 50);
}
function drawChart(){
  const w = el.chart.width, h = el.chart.height;
  chartCtx.clearRect(0,0,w,h);
  if (performanceHistory.length<2) return;
  const min = Math.min(...performanceHistory.map(p=>p.distance));
  const max = Math.max(...performanceHistory.map(p=>p.distance));
  const rng = (max-min)||1;
  chartCtx.beginPath();
  chartCtx.lineWidth = 2;
  chartCtx.strokeStyle = '#10b981';
  performanceHistory.forEach((p,i)=>{
    const x = 20 + i*(w-40)/(performanceHistory.length-1);
    const y = h-20 - ((p.distance-min)/rng)*(h-40);
    if(i===0) chartCtx.moveTo(x,y); else chartCtx.lineTo(x,y);
  });
  chartCtx.stroke();
}

/* ========= Problem + GA ========= */
function generateProblem(size){
  const w = el.canvas.width, h = el.canvas.height;
  problemData = Array.from({length:size},()=>({
    x: Math.random()*(w-100)+50, y: Math.random()*(h-100)+50
  }));
  bestSolution = { route: null, distance: Infinity };
  performanceHistory = [];
  drawProblem(); drawChart();
}
function createRandomRoute(n){
  const a = [...Array(n).keys()];
  for(let i=n-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function dist(route,cities){
  let s=0, n=route.length;
  for(let i=0;i<n;i++){
    const A = cities[route[i]], B = cities[route[(i+1)%n]];
    s += Math.hypot(A.x-B.x, A.y-B.y);
  }
  return s;
}
function selectParent(pop, fit){
  const k=3; let best= (Math.random()*pop.length)|0;
  for(let i=1;i<k;i++){ const idx=(Math.random()*pop.length)|0; if (fit[idx]>fit[best]) best=idx; }
  return pop[best];
}
function crossover(p1,p2){
  const n=p1.length, start=(Math.random()*n)|0, end=start+((Math.random()*(n-start))|0);
  const child = new Array(n).fill(-1), used=new Set();
  for(let i=start;i<=end;i++){ child[i]=p1[i]; used.add(p1[i]); }
  let pos=(end+1)%n;
  for(let i=0;i<n;i++){ const g=p2[(end+1+i)%n]; if(!used.has(g)){ child[pos]=g; pos=(pos+1)%n; } }
  return child;
}
function mutate(r){ const i=(Math.random()*r.length)|0, j=(Math.random()*r.length)|0; [r[i],r[j]]=[r[j],r[i]]; return r; }
function runEpoch(cities,{populationSize=60,generations=25,mutationRate=0.1}){
  let pop = Array.from({length:populationSize},()=>createRandomRoute(cities.length));
  let bestR=null, bestD=Infinity;
  for(let g=0; g<generations; g++){
    const fitness = pop.map(r=>1/dist(r,cities));
    for(let i=0;i<pop.length;i++){ const d=1/fitness[i]; if (d<bestD){ bestD=d; bestR=[...pop[i]]; } }
    const next=[...bestR];
    while(next.length<populationSize){
      const a=selectParent(pop, fitness), b=selectParent(pop, fitness);
      let child=crossover(a,b);
      if (Math.random()<mutationRate) child=mutate(child);
      next.push(child);
    }
    pop = next;
  }
  return { route: bestR, distance: bestD };
}

/* ========= Messaging (BroadcastChannel) ========= */
function send(m){ if(!bc) return; bc.postMessage({ ...m, sessionId, from: peerId }); }
if (bc){
  bc.onmessage = (e)=>{
    const m = e.data || {};
    if (!sessionId || m.sessionId!==sessionId) return;
    if (m.to && m.to!==peerId) return;

    switch(m.type){
      case 'HELLO':
        if (isCoordinator){
          nodes.set(m.from,{status:'connected', latency: Math.round(50+Math.random()*120), ops: 0});
          send({type:'WELCOME', to:m.from});
          updateMetrics(); renderWorkers();
          log(`üì± Worker joined: ${m.from}`);
        }
        break;
      case 'WELCOME':
        if (!isCoordinator){ setStatus('active','Connected as Worker'); log('‚úÖ Connected to coordinator'); }
        break;
      case 'TASK':
        if (!isCoordinator){
          const res = runEpoch(m.cities, m.params);
          send({type:'RESULT', to:m.from, result: res});
        }
        break;
      case 'RESULT':
        if (isCoordinator && m.result){
          metrics.totalOps++;
          const r = m.result;
          if (r.distance < bestSolution.distance){
            bestSolution = r;
            performanceHistory.push({time:Date.now(), distance:r.distance});
            drawProblem(); drawChart();
            updateMetrics();
            log(`üéØ Improved solution: ${Math.round(r.distance)} by ${m.from}`);
          }
          const n = nodes.get(m.from); if (n){ n.ops++; renderWorkers(); }
        }
        break;
      case 'BYE':
        if (isCoordinator){ nodes.delete(m.from); renderWorkers(); updateMetrics(); log(`üëã Worker left: ${m.from}`); }
        break;
    }
  };
}

/* ========= Demo Flow ========= */
function joinLink(){ return location.href.split('#')[0] + '#join=' + sessionId; }

function startDemo(){
  if (!bc){ alert('Your browser does not support BroadcastChannel. Try a modern browser.'); return; }
  sessionId = Math.random().toString(36).slice(2,10);
  isCoordinator = true; demoRunning = true;
  setStatus('active','Coordinator running');
  showSession();
  el.inviteSection.style.display = 'block';
  el.runOptimization.disabled = false;
  metrics.startTime = Date.now();
  nodes.clear(); renderWorkers(); updateMetrics();
  const link = joinLink();
  el.inviteUrl.textContent = `Join link: ${link}`;
  log(`üöÄ Session started ‚Ä¢ ID ${sessionId}`);
  log('Open this file in new tabs or share the join link. Then click ‚ÄúJoin as Worker‚Äù there.');

  // Dispatch tasks every 1.5s
  const loop = setInterval(()=>{
    if (!demoRunning || !isCoordinator) { clearInterval(loop); return; }
    if (nodes.size===0 || !optimizationRunning) return;
    for (const [id] of nodes){
      send({type:'TASK', to:id, cities: problemData, params: {
        populationSize: 30 + (+el.work.value)*3,
        generations: 10 + (+el.work.value)*2,
        mutationRate: 0.08
      }});
    }
  }, 1500);
}

function joinDemo(){
  if (!sessionId){
    const guess = prompt('Enter Session ID (visible on coordinator):', '');
    if (!guess) return;
    sessionId = guess.trim();
  }
  isCoordinator = false; demoRunning = true;
  setStatus('connecting','Joining‚Ä¶');
  showSession();
  send({type:'HELLO'});
}

function runOptimization(){
  if (!isCoordinator){ alert('Only the coordinator starts the optimization.'); return; }
  generateProblem(parseInt(el.size.value,10));
  optimizationRunning = true;
  el.runOptimization.disabled = true;
  log(`üéØ Optimization started ‚Ä¢ ${problemData.length} cities ‚Ä¢ workload ${el.work.value}/10`);
}

function openWorkerTab(){
  const url = location.href.split('#')[0] + '#join=' + (sessionId||'');
  const w = window.open(url, '_blank');
  if (!w) log('‚ùå Popup blocked ‚Äî allow popups or open a new tab manually');
}

/* ========= Controls ========= */
el.startDemo.addEventListener('click', startDemo);
el.joinDemo.addEventListener('click', joinDemo);
el.runOptimization.addEventListener('click', runOptimization);
el.openWorker.addEventListener('click', openWorkerTab);
el.size.addEventListener('input', e=> el.sizeLabel.textContent = e.target.value);
el.work.addEventListener('input', e=> el.workLabel.textContent = `${e.target.value}/10`);
el.copyIdBtn.addEventListener('click', async ()=>{
  if (!sessionId) return;
  try{ await navigator.clipboard.writeText(sessionId); log('üìã Session ID copied'); }catch{}
});
el.copyLinkBtn.addEventListener('click', async ()=>{
  if (!sessionId) return;
  const link = joinLink();
  try{ await navigator.clipboard.writeText(link); log('üìã Join link copied'); }catch{}
});

/* ========= Housekeeping ========= */
window.addEventListener('beforeunload', ()=>{ if (demoRunning) send({type:'BYE'}); });

/* ========= Metrics tick ========= */
setInterval(()=>{
  if (!demoRunning) return;
  updateMetrics();
  for(const [id,n] of nodes){ n.latency = Math.max(20, (n.latency||80) + (Math.random()*20-10)|0); }
  renderWorkers();
}, 1000);

/* ========= Quick join via #join=ID ========= */
window.addEventListener('load', ()=>{
  const m = location.hash.match(/join=([a-z0-9]+)/i);
  if (m){ sessionId = m[1]; showSession(); joinDemo(); }
});

/* ========= Hint ========= */
log('Tip: Start Demo in one tab, then open 2‚Äì3 more tabs ‚Üí Join as Worker.');
</script>
</body>
</html>
